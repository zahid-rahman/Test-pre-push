#!/bin/bash
#
# Git pre-push hook
# Prevents pushing if your local branch is behind or diverged from the remote.
# Safe for any branch (works with develop, main, feature, etc.)
#

set -e

# Get the current branch name
branch="$(git rev-parse --abbrev-ref HEAD)"
remote="origin"
remote_branch="$remote/$branch"

echo "ğŸ” Checking if '$branch' is up to date with '$remote_branch'..."

# Fetch the latest commits from remote (quietly)
git fetch $remote $branch --quiet

# Get the commit hashes
LOCAL=$(git rev-parse $branch)
REMOTE=$(git rev-parse $remote_branch)
BASE=$(git merge-base $branch $remote_branch)

# Compare commits
if [ "$LOCAL" = "$REMOTE" ]; then
    echo "âœ… Your branch is up to date with $remote_branch."
    exit 0
elif [ "$LOCAL" = "$BASE" ]; then
    echo "âŒ Push rejected: your branch is behind $remote_branch."
    echo "ğŸ‘‰ Run 'git pull --rebase $remote $branch' or 'git pull --rebase' before pushing again."
    exit 1
elif [ "$REMOTE" = "$BASE" ]; then
    echo "âœ… Your branch is ahead of $remote_branch. Safe to push."
    exit 0
else
    echo "âš ï¸ Push rejected: your branch and $remote_branch have diverged."
    echo "ğŸ‘‰ Run 'git pull --rebase' and resolve conflicts before pushing."
    exit 1
fi
