#!/bin/bash
#
# Git pre-push hook
# Blocks ANY push if local 'develop' is not up to date with 'origin/develop'.
#

set -e

BASE_BRANCH="develop"
REMOTE="origin"

echo "üîç Checking if your local '$BASE_BRANCH' is up to date with '$REMOTE/$BASE_BRANCH'..."

# Fetch latest develop info quietly
git fetch $REMOTE $BASE_BRANCH --quiet || true

# Get commit hashes (safe)
LOCAL=$(git rev-parse $BASE_BRANCH 2>/dev/null || echo "")
REMOTE_HEAD=$(git rev-parse $REMOTE/$BASE_BRANCH 2>/dev/null || echo "")
BASE=$(git merge-base $BASE_BRANCH $REMOTE/$BASE_BRANCH 2>/dev/null || echo "")

# Handle missing local develop
if [ -z "$LOCAL" ]; then
    echo "‚ùå Local '$BASE_BRANCH' branch not found. Please check it out first:"
    echo "   git fetch $REMOTE $BASE_BRANCH && git checkout $BASE_BRANCH"
    exit 1
fi

# Handle missing remote develop
if [ -z "$REMOTE_HEAD" ]; then
    echo "‚ö†Ô∏è Remote '$REMOTE/$BASE_BRANCH' not found. Cannot validate update status."
    exit 1
fi

# Compare commits safely (quotes are critical)
if [ "$LOCAL" = "$REMOTE_HEAD" ]; then
    echo "‚úÖ Local '$BASE_BRANCH' is up to date with '$REMOTE/$BASE_BRANCH'. Push allowed."
    exit 0
elif [ "$LOCAL" = "$BASE" ]; then
    echo "‚ùå Push rejected: your local '$BASE_BRANCH' is BEHIND '$REMOTE/$BASE_BRANCH'."
    echo "üëâ Please run: git checkout $BASE_BRANCH && git pull --rebase $REMOTE $BASE_BRANCH"
    echo "Then rebase your feature branch on top of the updated '$BASE_BRANCH'."
    exit 1
elif [ "$REMOTE_HEAD" = "$BASE" ]; then
    echo "‚ö†Ô∏è Local '$BASE_BRANCH' is AHEAD of '$REMOTE/$BASE_BRANCH'."
    echo "üëâ Push '$BASE_BRANCH' first before pushing other branches."
    exit 1
else
    echo "‚ö†Ô∏è Local '$BASE_BRANCH' and '$REMOTE/$BASE_BRANCH' have diverged."
    echo "üëâ Please pull/rebase and resolve conflicts before pushing."
    exit 1
fi
