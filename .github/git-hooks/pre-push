#!/bin/bash
#
# Git pre-push hook
# Ensures local 'develop' is up to date with 'origin/develop' before allowing ANY push.
#

set -e

BASE_BRANCH="develop"
REMOTE="origin"

echo "üîç Checking if your local '$BASE_BRANCH' branch is up to date with '$REMOTE/$BASE_BRANCH'..."

# Fetch the latest remote info quietly
git fetch $REMOTE $BASE_BRANCH --quiet || true

# Resolve commit hashes (safe)
LOCAL=$(git rev-parse $BASE_BRANCH 2>/dev/null || echo "")
REMOTE_HEAD=$(git rev-parse $REMOTE/$BASE_BRANCH 2>/dev/null || echo "")
BASE=$(git merge-base $BASE_BRANCH $REMOTE/$BASE_BRANCH 2>/dev/null || echo "")

# Handle case: local 'develop' missing
if [ -z "$LOCAL" ]; then
    echo "‚ùå Local '$BASE_BRANCH' branch not found. Please checkout it first:"
    echo "   git fetch $REMOTE $BASE_BRANCH && git checkout $BASE_BRANCH"
    exit 1
fi

# Handle case: remote 'develop' missing
if [ -z "$REMOTE_HEAD" ]; then
    echo "‚ö†Ô∏è Remote '$REMOTE/$BASE_BRANCH' not found. Cannot validate update status."
    exit 1
fi

# Compare commits safely
if [ "$LOCAL" = "$REMOTE_HEAD" ]; then
    echo "‚úÖ Local '$BASE_BRANCH' is up to date with '$REMOTE/$BASE_BRANCH'. Push allowed."
    exit 0
elif [ "$LOCAL" = "$BASE" ]; then
    echo "‚ùå Push rejected: your local '$BASE_BRANCH' is BEHIND '$REMOTE/$BASE_BRANCH'."
    echo "üëâ Please run: git checkout $BASE_BRANCH && git pull --rebase $REMOTE $BASE_BRANCH"
    echo "Then rebase your feature branch on top of the updated '$BASE_BRANCH'."
    exit 1
elif [ "$REMOTE_HEAD" = "$BASE" ]; then
    echo "‚ö†Ô∏è Local '$BASE_BRANCH' is AHEAD of '$REMOTE/$BASE_BRANCH'."
    echo "üëâ You need to push 'develop' first before pushing any feature branches."
    exit 1
else
    echo "‚ö†Ô∏è Your local '$BASE_BRANCH' and '$REMOTE/$BASE_BRANCH' have diverged."
    echo "üëâ Please pull/rebase and resolve conflicts before pushing."
    exit 1
fi
