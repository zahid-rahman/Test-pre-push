#!/bin/bash
#
# Git pre-push hook
# Blocks push if local 'develop' is not up to date with 'origin/develop'.
# Applies to ALL branches ‚Äî ensures 'develop' is always the latest base.
#

set -e

BASE_BRANCH="develop"
REMOTE="origin"

echo "üîç Checking if local '$BASE_BRANCH' is up to date with '$REMOTE/$BASE_BRANCH'..."

# Fetch the latest remote info quietly
git fetch $REMOTE $BASE_BRANCH --quiet

LOCAL=$(git rev-parse $BASE_BRANCH 2>/dev/null || echo "")
REMOTE_HEAD=$(git rev-parse $REMOTE/$BASE_BRANCH 2>/dev/null || echo "")
BASE=$(git merge-base $BASE_BRANCH $REMOTE/$BASE_BRANCH 2>/dev/null || echo "")

# If 'develop' doesn't exist locally yet
if [ -z "$LOCAL" ]; then
    echo "‚ö†Ô∏è Local '$BASE_BRANCH' branch not found. Please fetch it first:"
    echo "   git fetch $REMOTE $BASE_BRANCH && git checkout $BASE_BRANCH"
    exit 1
fi

# Compare commits
if [ "$LOCAL" = "$REMOTE_HEAD" ]; then
    echo "‚úÖ Local '$BASE_BRANCH' is up to date with '$REMOTE/$BASE_BRANCH'."
else
    echo "‚ùå Push rejected: your local '$BASE_BRANCH' is not up to date with '$REMOTE/$BASE_BRANCH'."
    echo "üëâ Please run: git checkout $BASE_BRANCH && git pull --rebase $REMOTE $BASE_BRANCH"
    echo "Then rebase your feature branch on top of the updated '$BASE_BRANCH' before pushing."
    exit 1
fi

# If up-to-date, allow push to continue
echo "‚úÖ Proceeding with push..."
exit 0
